{"version":3,"file":"useAppDetails-2293a569.esm.js","sources":["../../src/components/useAppDetails.ts"],"sourcesContent":["/*\n * Copyright 2021 Larder Software Limited\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { configApiRef, errorApiRef, useApi } from '@backstage/core-plugin-api';\nimport { useAsyncRetry } from 'react-use';\nimport { argoCDApiRef } from '../api';\n\nexport const useAppDetails = ({\n  appName,\n  appSelector,\n  appNamespace,\n  projectName,\n  url,\n}: {\n  appName?: string;\n  appSelector?: string;\n  appNamespace?: string;\n  projectName?: string;\n  url: string;\n}) => {\n  const api = useApi(argoCDApiRef);\n  const errorApi = useApi(errorApiRef);\n  const configApi = useApi(configApiRef);\n\n  const { loading, value, error, retry } = useAsyncRetry(async () => {\n    const argoSearchMethod: boolean = Boolean(\n      configApi.getOptionalConfigArray('argocd.appLocatorMethods')?.length,\n    );\n    try {\n      if (!argoSearchMethod && appName) {\n        return api.getAppDetails({ url, appName, appNamespace });\n      }\n      if (argoSearchMethod && appName) {\n        const kubeInfo = await api.serviceLocatorUrl({\n          appName: appName as string,\n          appNamespace: appNamespace,\n        });\n        if (kubeInfo instanceof Error) return kubeInfo;\n        const promises = kubeInfo.map(async (instance: any) => {\n          const apiOut = await api.getAppDetails({\n            url,\n            appName,\n            appNamespace,\n            instance: instance.name,\n          });\n          if (!apiOut.metadata) {\n            return {\n              status: {\n                history: [],\n                sync: { status: 'Missing' },\n                health: { status: 'Missing' },\n                operationState: {},\n              },\n              metadata: { name: appName, instance: instance.name },\n            };\n          }\n          apiOut.metadata.instance = instance;\n          return apiOut;\n        });\n        return Promise.all(promises);\n      }\n      if (argoSearchMethod && appSelector) {\n        const kubeInfo = await api.serviceLocatorUrl({\n          appSelector: appSelector as string,\n          appNamespace,\n        });\n        if (kubeInfo instanceof Error) return kubeInfo;\n        const promises = kubeInfo.map(async (instance: any) => {\n          return api.getAppListDetails({\n            url,\n            appSelector,\n            appNamespace,\n            instance: instance.name,\n          });\n        });\n        const output = await Promise.all(promises);\n        return {\n          items: output\n            .flatMap(argoCdAppList => argoCdAppList.items)\n            .filter(item => item !== null),\n        };\n      }\n      if (appSelector || projectName) {\n        return api.listApps({\n          url,\n          appSelector,\n          appNamespace,\n          projectName,\n        });\n      }\n      return Promise.reject('Neither appName nor appSelector provided');\n    } catch (e: any) {\n      errorApi.post(new Error('Something went wrong'));\n      return Promise.reject(e);\n    }\n  });\n  return {\n    loading,\n    value,\n    error,\n    retry,\n  };\n};\n"],"names":[],"mappings":"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"}